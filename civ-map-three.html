<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Civilization Map 3D Visualization (Modules)</title>
    <link rel="stylesheet" href="civ-map-three.css">
    <style>
        /* Basic styles */
        body { margin: 0; overflow: hidden; background-color: #f0f0f0; font-family: sans-serif; }
        #map-container { width: 100vw; height: 100vh; display: block; background-color: #111; position: relative; }
        .error-message { color: red; background: white; padding: 1em; border: 1px solid red; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; text-align: center; }
        #loading-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); color: white; display: flex; justify-content: center; align-items: center; z-index: 100; font-size: 1.2em; }

        /* Weight controls styles */
        .weights-controls { border-top: 1px solid #ccc; margin-top: 10px; padding-top: 10px; }
        .weights-header { cursor: pointer; font-weight: bold; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }
        .weights-header::after { content: '▲'; font-size: 0.8em; margin-left: 5px; }
        .weights-header.collapsed::after { content: '▼'; }
        .weights-content { display: block; padding-left: 10px; }
        .weights-content.hidden { display: none; }
        .weight-slider-group { margin-bottom: 8px; display: flex; align-items: center; gap: 10px; }
        .weight-slider-group label { min-width: 100px; font-size: 0.9em; }
        .weight-slider-group input[type="range"] { flex-grow: 1; cursor: pointer; }
        .weight-slider-group .slider-value { min-width: 30px; text-align: right; font-size: 0.9em; font-family: monospace; }
        .preset-buttons button { margin-right: 5px; margin-bottom: 5px; }

        /* Radius input style */
        .radius-input-label { display: inline-flex; align-items: center; gap: 5px; margin-left: 15px; }
        .radius-input-label input[type="number"] { width: 50px; padding: 2px 5px; }

        /* **** ADDED: Debug Mode Overlay Style **** */
        #debug-mode-overlay {
            position: absolute;
            top: 10px; /* Position below header */
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(255, 0, 255, 0.7); /* Magenta background */
            color: white;
            padding: 5px 15px;
            border-radius: 5px;
            font-size: 0.9em;
            font-weight: bold;
            z-index: 101; /* Above loading overlay if needed, below tooltip */
            display: none; /* Hidden by default */
            pointer-events: none; /* Allow clicks through */
        }
        /* ****************************************** */
        /* Style for the debug mode toggle */
        .debug-toggle-label {
            margin-left: 15px; /* Spacing */
        }

    </style>
</head>
<body>
    <div class="visualization-container">

        <div class="header">
            <h1>Civilization 3D Map Visualization</h1>
            <div class="controls">
                <div class="control-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="toggle-tier-labels" checked> Show Tier Labels
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="toggle-resources" checked> Show Resources
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="toggle-elevation" checked> Show Elevation
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="toggle-heatmap"> Show Score Heatmap
                    </label>
                    <label class="radius-input-label" for="hover-radius-input">
                        Hover Radius:
                        <input type="number" id="hover-radius-input" min="0" max="5" step="1" title="Set hover effect radius (0=center only)">
                    </label>
                    <label class="checkbox-label debug-toggle-label">
                        <input type="checkbox" id="toggle-debug-mode"> Enable Territory Visualization Mode
                    </label>
                    </div>

                <div class="control-group">
                     <button id="highlight-top-tiles" class="control-button" title="Highlight S and A tier tiles">Highlight Top Tiles</button>
                 </div>

                <div class="control-group tier-filters">
                    <span>Filter Tiers:</span>
                    <label><input type="checkbox" class="tier-checkbox" value="S" checked> S</label>
                    <label><input type="checkbox" class="tier-checkbox" value="A" checked> A</label>
                    <label><input type="checkbox" class="tier-checkbox" value="B" checked> B</label>
                    <label><input type="checkbox" class="tier-checkbox" value="C" checked> C</label>
                    <label><input type="checkbox" class="tier-checkbox" value="D" checked> D</label>
                    <label><input type="checkbox" class="tier-checkbox" value="E" checked> E</label>
                    <label><input type="checkbox" class="tier-checkbox" value="F" checked> F</label>
                    <button id="toggle-all-tiers" class="control-button" title="Select or deselect all tiers">Deselect All Tiers</button>
                </div>

                <div class="control-group weights-controls">
                    <div class="weights-header" id="weights-header">
                        <span>Scoring Weights</span>
                    </div>
                    <div class="weights-content" id="weights-content">
                        <div class="preset-buttons" id="preset-buttons">
                            <span>Presets:</span>
                            <button class="control-button preset-button" data-preset="balanced">Balanced</button>
                            <button class="control-button preset-button" data-preset="production">Production Focus</button>
                            <button class="control-button preset-button" data-preset="food_growth">Food/Growth Focus</button>
                            <button class="control-button preset-button" data-preset="gold">Gold Focus</button>
                            <button class="control-button preset-button" data-preset="science">Science/Culture (Appeal)</button>
                            <button class="control-button preset-button" id="reset-weights" title="Reset to default weights">Reset to Default</button>
                        </div>
                        <div class="weight-slider-group">
                            <label for="weight-food">Food:</label>
                            <input type="range" id="weight-food" class="weight-slider" data-weight-key="yields.food" min="0" max="3" step="0.1">
                            <span class="slider-value" id="weight-food-value">1.0</span>
                        </div>
                        <div class="weight-slider-group">
                            <label for="weight-production">Production:</label>
                            <input type="range" id="weight-production" class="weight-slider" data-weight-key="yields.production" min="0" max="3" step="0.1">
                            <span class="slider-value" id="weight-production-value">1.0</span>
                        </div>
                        <div class="weight-slider-group">
                            <label for="weight-gold">Gold:</label>
                            <input type="range" id="weight-gold" class="weight-slider" data-weight-key="yields.gold" min="0" max="3" step="0.1">
                            <span class="slider-value" id="weight-gold-value">0.5</span>
                        </div>
                        <div class="weight-slider-group">
                            <label for="weight-appeal">Appeal Bonus:</label>
                            <input type="range" id="weight-appeal" class="weight-slider" data-weight-key="bonuses.appeal_positive_factor" min="0" max="3" step="0.1">
                            <span class="slider-value" id="weight-appeal-value">0.5</span>
                        </div>
                         <div class="weight-slider-group">
                            <label for="weight-freshwater">Fresh Water Bonus:</label>
                            <input type="range" id="weight-freshwater" class="weight-slider" data-weight-key="bonuses.fresh_water" min="0" max="20" step="1">
                            <span class="slider-value" id="weight-freshwater-value">10</span>
                        </div>
                        <div class="weight-slider-group">
                            <label for="weight-resource-strategic">Strategic Res. Bonus:</label>
                            <input type="range" id="weight-resource-strategic" class="weight-slider" data-weight-key="bonuses.resource_strategic_factor" min="0" max="3" step="0.1">
                            <span class="slider-value" id="weight-resource-strategic-value">1.0</span>
                        </div>
                         <div class="weight-slider-group">
                            <label for="weight-resource-luxury">Luxury Res. Bonus:</label>
                            <input type="range" id="weight-resource-luxury" class="weight-slider" data-weight-key="bonuses.resource_luxury_factor" min="0" max="3" step="0.1">
                            <span class="slider-value" id="weight-resource-luxury-value">1.0</span>
                        </div>
                        <div class="weight-slider-group">
                            <label for="weight-balance">Yield Balance Bonus:</label>
                            <input type="range" id="weight-balance" class="weight-slider" data-weight-key="bonuses.balance_factor" min="0" max="2" step="0.1">
                            <span class="slider-value" id="weight-balance-value">0.5</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="map-container">
            <div id="debug-mode-overlay">TERRITORY VISUALIZATION MODE ACTIVE (ESC to exit)</div>
            <div id="loading-overlay">
                 <div id="loading-content" style="text-align: center;">
                    <div id="loading-text" style="margin-bottom: 15px;">Loading Map Data... 0%</div>
                    <div id="progress-bar-container" style="width: 80%; max-width: 400px; height: 20px; background-color: #555; border-radius: 10px; overflow: hidden; margin: 0 auto;">
                        <div id="progress-bar" style="width: 0%; height: 100%; background-color: #4caf50; border-radius: 10px; transition: width 0.3s ease-out;"></div>
                    </div>
                    <div id="loading-error" style="display: none; color: #ff6b6b; margin-top: 15px; font-weight: bold;"></div>
                </div>
            </div>
            <div id="tooltip" class="tooltip"></div>
        </div>

        <div class="legend">
            <div class="legend-header">
                <h3>Legend</h3>
                <span class="legend-toggle" id="legend-toggle">Hide</span>
            </div>
            <div class="legend-content">
                <div class="legend-section">
                    <h4>Terrain Types</h4>
                    <div id="terrain-legend">
                        </div>
                </div>
                <div class="legend-section">
                    <h4>Resource Types</h4>
                    <div id="resource-legend">
                        <div class="legend-item">
                            <div class="legend-color resource-luxury"></div><span>Luxury</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color resource-strategic"></div><span>Strategic</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color resource-bonus"></div><span>Bonus</span>
                        </div>
                    </div>
                </div>
                <div class="legend-section">
                    <h4>Tile Score Tiers</h4>
                    <div id="tier-legend">
                        </div>
                </div>
                 <div class="legend-section" id="heatmap-legend-section" style="display: none;">
                     <h4>Score Heatmap</h4>
                    <div class="heatmap-gradient"></div>
                    <div class="heatmap-labels">
                        <span id="heatmap-min-label">Min</span>
                        <span id="heatmap-max-label">Max</span>
                    </div>
                </div>
            </div>
        </div>

        <button id="show-legend-button" class="control-button">
            Show Legend
        </button>
        <div id="debug-info" style="display: none;">
            <h3>Debug Info</h3>
            <div id="debug-content"></div>
        </div>

    </div> <script type="importmap">
      {
        "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.146.0/build/three.module.js",
          "three/examples/jsm/controls/OrbitControls.js": "https://cdn.jsdelivr.net/npm/three@0.146.0/examples/jsm/controls/OrbitControls.js"
        }
      }
    </script>

    <script type="module" src="./modules/main.js"></script>

    <script>
        // Simple diagnostic
        setTimeout(() => {
            const canvas = document.querySelector('#map-container canvas');
            if (!canvas) console.warn("Diagnostic: Canvas element not found in map container after delay.");
            fetch('civ_map_data.json')
                .then(response => console.log(`Diagnostic: civ_map_data.json fetch status: ${response.status}`))
                .catch(error => console.warn(`Diagnostic: Error fetching civ_map_data.json: ${error.message}`));
        }, 3000);
    </script>

</body>
</html>
