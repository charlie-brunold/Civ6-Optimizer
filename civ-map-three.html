<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Civilization Map 3D Visualization (Modules)</title>
    <link rel="stylesheet" href="civ-map-three.css">
    <style>
        /* Basic styles needed before CSS loads or if CSS fails */
        body { margin: 0; overflow: hidden; background-color: #f0f0f0; }
        #map-container { width: 100vw; height: 100vh; display: block; background-color: #111; position: relative; /* Needed for overlay */}
        .error-message { /* Basic error styling */
            color: red; background: white; padding: 1em; border: 1px solid red;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 1000; text-align: center;
         }
        /* Basic loading overlay style */
        #loading-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.7); color: white;
            display: flex; justify-content: center; align-items: center;
            z-index: 100; /* Ensure it's above map content */
        }
    </style>
</head>
<body>
    <div class="visualization-container">

        <div class="header">
            <h1>Civilization 3D Map Visualization</h1>
            <div class="controls">
                <div class="control-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="toggle-tier-labels" checked> Show Tier Labels
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="toggle-resources" checked> Show Resources
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="toggle-elevation" checked> Show Elevation
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="toggle-heatmap"> Show Score Heatmap
                    </label>
                </div>

                 <div class="control-group">
                     <button id="highlight-top-tiles" class="control-button" title="Highlight S and A tier tiles">Highlight Top Tiles</button>
                 </div>


                <div class="control-group tier-filters">
                    <span>Filter Tiers:</span>
                    <label><input type="checkbox" class="tier-checkbox" value="S" checked> S</label>
                    <label><input type="checkbox" class="tier-checkbox" value="A" checked> A</label>
                    <label><input type="checkbox" class="tier-checkbox" value="B" checked> B</label>
                    <label><input type="checkbox" class="tier-checkbox" value="C" checked> C</label>
                    <label><input type="checkbox" class="tier-checkbox" value="D" checked> D</label>
                    <label><input type="checkbox" class="tier-checkbox" value="E" checked> E</label>
                    <label><input type="checkbox" class="tier-checkbox" value="F" checked> F</label>
                    <button id="toggle-all-tiers" class="control-button" title="Select or deselect all tiers">Deselect All Tiers</button>
                </div>
            </div>
        </div>

        <div id="map-container">
            <div id="loading-overlay">
                <div id="loading-content" style="text-align: center;">
                    <div id="loading-text" style="margin-bottom: 15px; font-size: 1.2em;">Loading Map Data... 0%</div>
                    <div id="progress-bar-container" style="width: 80%; max-width: 400px; height: 20px; background-color: #555; border-radius: 10px; overflow: hidden; margin: 0 auto;">
                        <div id="progress-bar" style="width: 0%; height: 100%; background-color: #4caf50; border-radius: 10px; transition: width 0.3s ease-out;"></div>
                    </div>
                    <div id="loading-error" style="display: none; color: #ff6b6b; margin-top: 15px; font-weight: bold;"></div>
                </div>
            </div>
            <div id="tooltip" class="tooltip"></div> </div>

        <div class="legend">
            <div class="legend-header">
                <h3>Legend</h3>
                <span class="legend-toggle" id="legend-toggle">Hide</span>
            </div>
            <div class="legend-content">
                <div class="legend-section">
                    <h4>Terrain Types</h4>
                    <div id="terrain-legend">
                        </div>
                </div>
                <div class="legend-section">
                    <h4>Resource Types</h4>
                    <div id="resource-legend">
                        <div class="legend-item">
                            <div class="legend-color resource-luxury"></div><span>Luxury</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color resource-strategic"></div><span>Strategic</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color resource-bonus"></div><span>Bonus</span>
                        </div>
                    </div>
                </div>
                <div class="legend-section">
                    <h4>Tile Score Tiers</h4>
                    <div id="tier-legend">
                        <div class="legend-item"><div class="tier-symbol tier-S">S</div><span>Top 5%</span></div>
                        <div class="legend-item"><div class="tier-symbol tier-A">A</div><span>85%-95%</span></div>
                        <div class="legend-item"><div class="tier-symbol tier-B">B</div><span>65%-85%</span></div>
                        <div class="legend-item"><div class="tier-symbol tier-C">C</div><span>35%-65%</span></div>
                        <div class="legend-item"><div class="tier-symbol tier-D">D</div><span>15%-35%</span></div>
                        <div class="legend-item"><div class="tier-symbol tier-E">E</div><span>5%-15%</span></div>
                        <div class="legend-item"><div class="tier-symbol tier-F">F</div><span>Bottom 5%</span></div>
                    </div>
                </div>
                 <div class="legend-section" id="heatmap-legend-section" style="display: none;"> <h4>Score Heatmap</h4>
                    <div class="heatmap-gradient"></div> <div class="heatmap-labels">
                        <span id="heatmap-min-label">Min</span>
                        <span id="heatmap-max-label">Max</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="debug-info" style="display: none;"> <h3>Debug Info</h3>
            <div id="debug-content"></div>
        </div>

    </div>

    <script type="importmap">
      {
        "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.146.0/build/three.module.js",
          "three/examples/jsm/controls/OrbitControls.js": "https://cdn.jsdelivr.net/npm/three@0.146.0/examples/jsm/controls/OrbitControls.js"
        }
      }
    </script>

    <script type="module" src="./modules/main.js"></script>

    <script>
        setTimeout(() => {
            const canvas = document.querySelector('#map-container canvas');
            if (!canvas) console.warn("Diagnostic: Canvas element not found in map container after delay.");
            fetch('civ_map_data.json')
                .then(response => console.log(`Diagnostic: civ_map_data.json fetch status: ${response.status}`))
                .catch(error => console.warn(`Diagnostic: Error fetching civ_map_data.json: ${error.message}`));
        }, 3000);
    </script>

</body>
</html>